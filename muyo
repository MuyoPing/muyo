--!strict

-- Rayfield UI 로드
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local player = game.Players.LocalPlayer
local mouse = player:GetMouse()
local runService = game:GetService("RunService")

-- 블록 관리
local registeredBlocks = {}
local spawnMode = false
local followPointMode = false
local followLockPos = nil
local spawnPos = player.Character and player.Character.PrimaryPart and player.Character.PrimaryPart.Position or Vector3.new(0,0,0)
local baseRadius = 20
local baseSpeed = 5
local radiusIncrement = 0.5
local speedIncrement = 0.5
local angleOffset = 0
local targetPlayer = nil
local followDistance = 50

-- 보호막 모드
local uMode = false
local uDistance = 50

-- Rayfield UI 생성
local Window = Rayfield:CreateWindow({
    Name = "반물사 스크립트",
    LoadingTitle = "반물사",
    LoadingSubtitle = "by 무요핑",
    ConfigurationSaving = { Enabled = false }
})

-- 메인 탭
local MainTab = Window:CreateTab("메인", 4483362458)
local ModeLabel = MainTab:CreateLabel("현재 모드: 원형 회전")

-- 보호 탭 생성
local ProtectionTab = Window:CreateTab("보호", 4483362458)

-- 안티 그렙 상태 플래그
local antiGrabEnabled = false
local antiGrabConnection = nil
local struggleConnection = nil

-- 레그돌 함수
local function setRagdollF(state)
    local rs = game:GetService("ReplicatedStorage")
    local plr = game.Players.LocalPlayer
    local char = plr.Character or plr.CharacterAdded:Wait()
    local hrp = char:WaitForChild("HumanoidRootPart")
    if char and char:FindFirstChild("HumanoidRootPart") then
        rs:WaitForChild("CharacterEvents"):WaitForChild("RagdollRemote"):FireServer(hrp, state and 1 or 0)
    end
end

-- 앵커 함수
local function setAnchorF(state)
    local plr = game.Players.LocalPlayer
    local char = plr.Character or plr.CharacterAdded:Wait()
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if hrp then
        hrp.Anchored = state
    end
end

-- 안티 그렙 토글
ProtectionTab:CreateToggle({
    Name = "안티 그렙",
    CurrentValue = false,
    Callback = function(Value)
        antiGrabEnabled = Value

        -- 켜기
        if antiGrabEnabled then
            local rs = game:GetService("ReplicatedStorage")
            local plr = game.Players.LocalPlayer
            local runService = game:GetService("RunService")

            antiGrabConnection = runService.Heartbeat:Connect(function()
                local heldValue = plr:FindFirstChild("IsHeld")

                if heldValue and heldValue.Value == true then
                    if not struggleConnection then
                        -- 잡힘 → 레그돌 & 앵커 ON
                        setRagdollF(true)
                        setAnchorF(true)

                        -- 잡힌 동안 Struggle 반복 호출
                        struggleConnection = runService.Heartbeat:Connect(function()
                            rs.CharacterEvents.Struggle:FireServer(plr)
                        end)
                    end
                else
                    if struggleConnection then
                        -- 풀림 → 레그돌 & 앵커 OFF
                        setRagdollF(false)
                        setAnchorF(false)

                        -- Struggle 중지
                        struggleConnection:Disconnect()
                        struggleConnection = nil
                    end
                end
            end)

        -- 끄기
        else
            if antiGrabConnection then
                antiGrabConnection:Disconnect()
                antiGrabConnection = nil
            end
            if struggleConnection then
                struggleConnection:Disconnect()
                struggleConnection = nil
            end

            -- 혹시 켜져 있으면 풀기
            setRagdollF(false)
            setAnchorF(false)
        end
    end
})


-- 📌 그렙 탭 생성
local GrapTab = Window:CreateTab("그렙", 4483362458)
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local localPlayer = Players.LocalPlayer

-- 상태 변수
local noclipTargetEnabled = false
local grabbedPartsOriginal = {}

-- 내 캐릭터 파츠 제외
local function getMyParts()
    local char = localPlayer.Character
    if not char then return {} end
    local parts = {}
    for _, p in ipairs(char:GetDescendants()) do
        if p:IsA("BasePart") then
            parts[p] = true
        end
    end
    return parts
end

-- 잡은 오브젝트 파츠 가져오기 (내 캐릭터 제외)
local function getGrabbedParts()
    local owned = {}
    local myParts = getMyParts()
    for _, part in ipairs(workspace:GetDescendants()) do
        if part:IsA("BasePart") and not myParts[part] then
            local owner = nil
            pcall(function() owner = part:GetNetworkOwner() end)
            if owner == localPlayer then
                table.insert(owned, part)
            end
        end
    end
    return owned
end

-- 토글 UI
GrapTab:CreateToggle({
    Name = "노클립 그렙",
    CurrentValue = false,
    Callback = function(value)
        noclipTargetEnabled = value
        if not value then
            -- 끄면 기존 저장값 복구
            for p, val in pairs(grabbedPartsOriginal) do
                if p and p.Parent then
                    p.CanCollide = val
                end
            end
            grabbedPartsOriginal = {}
        end
    end
})

-- Heartbeat 루프: 토글 켜져 있으면 자동 노클립 유지
RunService.Heartbeat:Connect(function()
    if noclipTargetEnabled then
        local grabbed = getGrabbedParts()
        -- 새로 잡은 파츠 적용
        for _, p in ipairs(grabbed) do
            if grabbedPartsOriginal[p] == nil then
                grabbedPartsOriginal[p] = p.CanCollide
            end
            p.CanCollide = false
        end
        -- 놓은 파츠 복구
        for p, _ in pairs(grabbedPartsOriginal) do
            if not table.find(grabbed, p) and p and p.Parent then
                p.CanCollide = grabbedPartsOriginal[p]
                grabbedPartsOriginal[p] = nil
            end
        end
    end
end)

-- 📌 플레이어 탭 생성
local PlayerTab = Window:CreateTab("플레이어", 4483362458)
local localPlayer = game.Players.LocalPlayer
local runService = game:GetService("RunService")

-- 상태 변수
local walkSpeedValue = 16 -- 기본 속도
local infiniteJumpEnabled = false
local noclipEnabled = false

-- 🟢 노클립 관련 변수
local steppedConnection = nil
local originalCanCollide = {}
local PART_NAMES = {"Head","Torso","UpperTorso","LowerTorso","HumanoidRootPart"}

-- 🟢 캐릭터 파츠 모으기
local function getCharacterParts(char)
    local parts = {}
    for _, name in ipairs(PART_NAMES) do
        local p = char:FindFirstChild(name)
        if p and p:IsA("BasePart") then
            table.insert(parts, p)
        end
    end
    return parts
end

-- 🟢 노클립 켜기
local function enableNoclip(char)
    char = char or localPlayer.Character or localPlayer.CharacterAdded:Wait()
    if noclipEnabled then return end
    local parts = getCharacterParts(char)

    -- 원래값 저장
    originalCanCollide = {}
    for _, p in ipairs(parts) do
        originalCanCollide[p] = p.CanCollide
    end

    steppedConnection = runService.Stepped:Connect(function()
        for _, p in ipairs(parts) do
            if p and p.Parent then
                p.CanCollide = false
            end
        end
    end)

    noclipEnabled = true
    warn("[noclip] enabled")
end

-- 🟢 노클립 끄기
local function disableNoclip(char)
    char = char or localPlayer.Character
    if not noclipEnabled then return end

    if steppedConnection then
        steppedConnection:Disconnect()
        steppedConnection = nil
    end

    -- 복구
    if char then
        for p, val in pairs(originalCanCollide) do
            if p and p.Parent then
                p.CanCollide = val
            end
        end
    end

    originalCanCollide = {}
    noclipEnabled = false
    warn("[noclip] disabled")
end

-- 걷기 속도 슬라이더
PlayerTab:CreateSlider({
    Name = "걷기 속도",
    Range = {16,500},
    Increment = 1,
    CurrentValue = walkSpeedValue,
    Callback = function(value)
        walkSpeedValue = value
        local char = localPlayer.Character
        if char then
            local humanoid = char:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = walkSpeedValue
            end
        end
    end
})

-- 무한 점프 토글
PlayerTab:CreateToggle({
    Name = "무한 점프",
    CurrentValue = false,
    Callback = function(value)
        infiniteJumpEnabled = value
    end
})

-- 🟢 노클립 토글 (버튼 유지)
PlayerTab:CreateToggle({
    Name = "노클립",
    CurrentValue = false,
    Callback = function(value)
        if value then
            enableNoclip()
        else
            disableNoclip()
        end
    end
})

-- 무한 점프 구현 (Space 키 입력)
local uis = game:GetService("UserInputService")
uis.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.Space and infiniteJumpEnabled then
        local char = localPlayer.Character
        local humanoid = char and char:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
        end
    end
end)

-- 캐릭터 초기화 (걷기 속도 적용)
local function setupCharacter(char)
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid.WalkSpeed = walkSpeedValue
    end

    -- 만약 리스폰했는데 노클립이 켜져있으면 다시 적용
    if noclipEnabled then
        enableNoclip(char)
    end
end

-- 캐릭터 초기 적용
if localPlayer.Character then
    setupCharacter(localPlayer.Character)
end

-- 캐릭터 리스폰 시 적용
localPlayer.CharacterAdded:Connect(function(char)
    setupCharacter(char)
end)

-- Heartbeat 루프: 걷기 속도 유지
runService.Heartbeat:Connect(function()
    local char = localPlayer.Character
    if not char then return end
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid.WalkSpeed = walkSpeedValue
    end
end)

-- 📌 텔레포트 탭 생성
local TeleportTab = Window:CreateTab("텔레포트", 4483362458)
local player = game.Players.LocalPlayer
local runService = game:GetService("RunService")

-- 스폰 구역 텔레포트 버튼
TeleportTab:CreateButton({
    Name = "스폰 구역으로 이동",
    Callback = function()
        local char = player.Character or player.CharacterAdded:Wait()
        local root = char:WaitForChild("HumanoidRootPart")
        local spawnLocation = workspace:FindFirstChildWhichIsA("SpawnLocation")

        if spawnLocation then
            root.CFrame = spawnLocation.CFrame + Vector3.new(0, 5, 0)
            Rayfield:Notify({ Title = "텔레포트 성공", Content = "스폰 지점으로 이동했습니다.", Duration = 3 })
        else
            Rayfield:Notify({ Title = "텔레포트 실패", Content = "스폰 구역을 찾을 수 없습니다.", Duration = 5 })
        end
    end
})

-- 플레이어 목록 준비 (표시닉 + 본닉)
local function getPlayerList()
    local list = {}
    for _, plr in ipairs(game.Players:GetPlayers()) do
        if plr ~= player then
            table.insert(list, plr.DisplayName .. " (" .. plr.Name .. ")")
        end
    end
    return list
end

local SelectedPlayer = nil

-- 드롭다운
local PlayerDropdown = TeleportTab:CreateDropdown({
    Name = "플레이어 선택",
    Options = getPlayerList(),
    CurrentOption = "",
    MultiSelection = false,
    Callback = function(option)
        if type(option) == "table" then
            option = option[1]
        end
        -- 본닉(Name)만 추출
        local selectedName = option:match("%((.-)%)")
        SelectedPlayer = game.Players:FindFirstChild(selectedName)

        if SelectedPlayer then
            Rayfield:Notify({
                Title = "선택됨",
                Content = SelectedPlayer.DisplayName .. " (" .. SelectedPlayer.Name .. ") 님이 선택되었습니다.",
                Duration = 3
            })
        end
    end
})

-- 플레이어 목록 새로고침 버튼
TeleportTab:CreateButton({
    Name = "플레이어 목록 새로고침",
    Callback = function()
        -- 최신 플레이어 목록 가져오기
        local refreshedList = {}
        for _, plr in ipairs(game.Players:GetPlayers()) do
            if plr ~= player then
                table.insert(refreshedList, plr.DisplayName .. " (" .. plr.Name .. ")")
            end
        end

        -- 드롭다운 옵션 완전히 새로 적용
        PlayerDropdown:Refresh(refreshedList, true)
        PlayerDropdown:SetOption("") -- 선택 초기화
        SelectedPlayer = nil

        Rayfield:Notify({
            Title = "목록 새로고침",
            Content = "플레이어 목록이 갱신되었습니다.",
            Duration = 3
        })
    end
})

-- 선택된 플레이어에게 텔레포트 버튼
TeleportTab:CreateButton({
    Name = "선택한 플레이어한테 텔레포트",
    Callback = function()
        if SelectedPlayer and SelectedPlayer.Character and SelectedPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local targetHRP = SelectedPlayer.Character.HumanoidRootPart
            local myChar = player.Character or player.CharacterAdded:Wait()
            local myHRP = myChar:WaitForChild("HumanoidRootPart")

            -- 네트워크 오너권 가져오기 시도 (가능한 게임에서만)
            pcall(function()
                targetHRP:SetNetworkOwner(player)
            end)

            myHRP.CFrame = targetHRP.CFrame + Vector3.new(0, 3, 0)

            Rayfield:Notify({
                Title = "텔레포트 성공",
                Content = SelectedPlayer.DisplayName .. " (" .. SelectedPlayer.Name .. ") 님에게 이동했습니다.",
                Duration = 3
            })
        else
            Rayfield:Notify({
                Title = "텔레포트 실패",
                Content = "플레이어를 선택하지 않았거나 위치를 찾을 수 없습니다.",
                Duration = 3
            })
        end
    end
})

-- 사용법 탭
local HelpTab = Window:CreateTab("사용법", 4483362458)
HelpTab:CreateLabel("t키/버튼 → 블록 등록")
HelpTab:CreateLabel("y키 → 마우스 위치 따라가기 / 다시 y → 고정 위치")
HelpTab:CreateLabel("k키 → 플레이어 추적")
HelpTab:CreateLabel("z키 → 텔레포트")
HelpTab:CreateLabel("U모드 → 보호막 모드 (슬라이더로 반지름 조절)")
HelpTab:CreateLabel("마우스 휠 → y키 거리 조절 / U 모드 반지름 조절")
HelpTab:CreateLabel("v키/버튼 → 모든 블록 해제")
HelpTab:CreateLabel("c키/버튼 → 스폰 위치 이동")
HelpTab:CreateLabel("k키 → UI 가리기 켜기")
HelpTab:CreateLabel("속도 조절 앉으면 됨")

-- 기능 함수들
local function registerBlock(block)
    if block and block:IsA("BasePart") and not block.Anchored then
        registeredBlocks[block] = true
    end
end

local function unregisterAllBlocks()
    registeredBlocks = {}
end

local function restoreOwnership()
    for block in pairs(registeredBlocks) do
        if block.Parent and block:IsA("BasePart") then
            block.Anchored = false
            block:SetNetworkOwner(player)
        end
    end
end

-- 원형 회전
local function updateCircularPlacement()
    local char = player.Character
    if not char or not char.PrimaryPart then return end

    local center = char.PrimaryPart.Position
    local count = 0
    for block in pairs(registeredBlocks) do
        if block.Parent then
            count += 1
        end
    end

    if count == 0 then return end

    local radius = baseRadius + (count-1)*radiusIncrement
    local speed = baseSpeed + (count-1)*speedIncrement
    local i = 0

    for block in pairs(registeredBlocks) do
        if block.Parent then
            local angle = (i/count)*math.pi*2 + angleOffset
            local targetPos = center + Vector3.new(math.cos(angle)*radius, 0, math.sin(angle)*radius)
            block.AssemblyLinearVelocity = (targetPos - block.Position) * speed
            i += 1
        end
    end
end

-- 스폰 이동
local function updateSpawnPlacement()
    local targetPos = spawnPos + Vector3.new(0,100,0)
    for block in pairs(registeredBlocks) do
        if block.Parent then
            block.AssemblyLinearVelocity = (targetPos - block.Position) * 5
        end
    end
end

-- 플레이어 추적
local function updateTargetTracking()
    if not targetPlayer or not targetPlayer.Character or not targetPlayer.Character.PrimaryPart then return end

    local targetPos = targetPlayer.Character.PrimaryPart.Position
    for block in pairs(registeredBlocks) do
        if block.Parent then
            block.AssemblyLinearVelocity = (targetPos - block.Position) * 8
        end
    end
end

-- 마우스 따라가기
local function updateFollowPointPlacement()
    local char = player.Character
    if not char or not char.PrimaryPart then return end

    local basePos = char.PrimaryPart.Position
    local targetCenter

    if followLockPos then
        targetCenter = followLockPos
    else
        local mouseRay = workspace.CurrentCamera:ScreenPointToRay(mouse.X, mouse.Y)
        local dir = mouseRay.Direction.Unit
        targetCenter = basePos + dir * followDistance
    end

    for block in pairs(registeredBlocks) do
        if block.Parent then
            block.AssemblyLinearVelocity = (targetCenter - block.Position) * 8
        end
    end
end

-- 자동 반구 보호막
local function updateDomePlacement()
    local char = player.Character
    if not char or not char.PrimaryPart then return end

    local center = char.PrimaryPart.Position
    local blocks = {}

    for block in pairs(registeredBlocks) do
        if block.Parent then
            table.insert(blocks, block)
        end
    end

    local total = #blocks
    if total == 0 then return end

    local layerHeight = 15
    local layerRadiusStep = 15
    local idx = 1
    local layers = math.ceil(math.sqrt(total))

    for layer = 0, layers-1 do
        local y = layer * layerHeight
        local radius = math.max(0, uDistance - layer*layerRadiusStep)
        local circumference = 2*math.pi*radius
        local cols = math.max(1, math.floor(circumference/10))

        for col = 0, cols-1 do
            if idx > total then return end
            local angle = (col/cols)*2*math.pi
            local x = radius * math.cos(angle)
            local z = radius * math.sin(angle)
            local block = blocks[idx]
            local targetPos = center + Vector3.new(x, y, z)
            block.AssemblyLinearVelocity = (targetPos - block.Position) * 10
            idx += 1
        end
    end
end

-- Rayfield 버튼
MainTab:CreateButton({ Name="블록 등록 (마우스)", Callback=function()
    local target = mouse.Target
    registerBlock(target)
end})

MainTab:CreateButton({ Name="모든 블록 해제", Callback=unregisterAllBlocks })

MainTab:CreateButton({ Name="텔레포트 (마우스 위치)", Callback=function()
    local char = player.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        local root = char.HumanoidRootPart
        root.CFrame = CFrame.new(mouse.Hit.Position + Vector3.new(0,3,0))
    end
end})

MainTab:CreateToggle({
    Name="보호막 모드",
    CurrentValue=uMode,
    Callback=function(Value)
        uMode = Value
        if uMode then
            followPointMode = false
            spawnMode = false
            targetPlayer = nil
            restoreOwnership()
        end
    end
})

MainTab:CreateSlider({
    Name="보호막 반지름",
    Range={10,300},
    Increment=5,
    CurrentValue=uDistance,
    Callback=function(Value)
        uDistance = Value
    end
})

-- 키다운 기능
local function onKeyDown(key)
    if key=="t" then
        local target = mouse.Target
        registerBlock(target)
    elseif key=="y" then
        uMode=false
        if followPointMode and not followLockPos then
            local char=player.Character
            if char and char.PrimaryPart then
                local mouseRay = workspace.CurrentCamera:ScreenPointToRay(mouse.X, mouse.Y)
                local dir = mouseRay.Direction.Unit
                followLockPos = char.PrimaryPart.Position + dir*followDistance
            end
        elseif followPointMode and followLockPos then
            followLockPos=nil
            followPointMode=false
        else
            followPointMode=true
            followLockPos=nil
            restoreOwnership()
        end
    elseif key=="k" then
        uMode=false
        local target = mouse.Target
        local newTargetPlayer = nil
        if target then
            local model = target:FindFirstAncestorWhichIsA("Model")
            if model and game.Players:GetPlayerFromCharacter(model) and model ~= player.Character then
                newTargetPlayer = game.Players:GetPlayerFromCharacter(model)
            end
        end
        if newTargetPlayer then
            targetPlayer=newTargetPlayer
            followPointMode=false
            followLockPos=nil
            spawnMode=false
            for block in pairs(registeredBlocks) do
                if block and block.Parent then
                    block:SetNetworkOwner(player)
                end
            end
        else
            targetPlayer=nil
        end
    elseif key=="z" then
        local char=player.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            char.HumanoidRootPart.CFrame = CFrame.new(mouse.Hit.Position + Vector3.new(0,3,0))
        end
    elseif key=="v" then
        unregisterAllBlocks()
    elseif key=="c" then
        uMode=false
        spawnMode=not spawnMode
        if spawnMode then
            followPointMode=false
            followLockPos=nil
            targetPlayer=nil
            restoreOwnership()
        end
  -- Rayfield UI 키바인드 설정 (m 키로 UI 토글)
Window:ToggleUIKeybind(Enum.KeyCode.M)

    end
end

mouse.KeyDown:Connect(onKeyDown)

-- Heartbeat 루프
runService.Heartbeat:Connect(function()
    if uMode then
        updateDomePlacement()
        ModeLabel:Set("현재 모드: 보호막 모드 (반지름 "..uDistance..")")
    elseif targetPlayer then
        updateTargetTracking()
        ModeLabel:Set("현재 모드: 플레이어 추적 → "..targetPlayer.Name)
    elseif followPointMode then
        updateFollowPointPlacement()
        if followLockPos then
            ModeLabel:Set("현재 모드: 고정 위치 유지")
        else
            ModeLabel:Set("현재 모드: 마우스 이동 ("..followDistance.." Studs)")
        end
    elseif spawnMode then
        updateSpawnPlacement()
        ModeLabel:Set("현재 모드: 스폰 위치 이동")
    else
        angleOffset += (baseSpeed + (#registeredBlocks-1)*speedIncrement) * 0.01
        updateCircularPlacement()
        ModeLabel:Set("현재 모드: 원형 회전")
    end
end)

-- 마우스 휠
mouse.WheelForward:Connect(function()
    if followPointMode and not followLockPos then
        followDistance = math.min(followDistance+5,300)
    elseif uMode then
        uDistance = math.min(uDistance+5,300)
    end
end)

mouse.WheelBackward:Connect(function()
    if followPointMode and not followLockPos then
        followDistance = math.max(followDistance-5,10)
    elseif uMode then
        uDistance = math.max(uDistance-5,10)
    end
end)
