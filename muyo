--!strict

-- Rayfield UI ë¡œë“œ
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local player = game.Players.LocalPlayer
local mouse = player:GetMouse()
local runService = game:GetService("RunService")

-- ë¸”ë¡ ê´€ë¦¬
local registeredBlocks = {}
local spawnMode = false
local followPointMode = false
local followLockPos = nil
local spawnPos = player.Character and player.Character.PrimaryPart and player.Character.PrimaryPart.Position or Vector3.new(0,0,0)
local baseRadius = 20
local baseSpeed = 5
local radiusIncrement = 0.5
local speedIncrement = 0.5
local angleOffset = 0
local targetPlayer = nil
local followDistance = 50

-- ë³´í˜¸ë§‰ ëª¨ë“œ
local uMode = false
local uDistance = 50

-- Rayfield UI ìƒì„±
local Window = Rayfield:CreateWindow({
    Name = "ë°˜ë¬¼ì‚¬ ìŠ¤í¬ë¦½íŠ¸",
    LoadingTitle = "ë°˜ë¬¼ì‚¬",
    LoadingSubtitle = "by ë¬´ìš”í•‘",
    ConfigurationSaving = { Enabled = false }
})

-- ë©”ì¸ íƒ­
local MainTab = Window:CreateTab("ë©”ì¸", 4483362458)
local ModeLabel = MainTab:CreateLabel("í˜„ì¬ ëª¨ë“œ: ì›í˜• íšŒì „")

-- ë³´í˜¸ íƒ­ ìƒì„±
local ProtectionTab = Window:CreateTab("ë³´í˜¸", 4483362458)

-- ì•ˆí‹° ê·¸ë ™ í† ê¸€ í”Œë˜ê·¸
local antiGrabEnabled = false
local antiGrabConnection = nil

ProtectionTab:CreateToggle({
    Name = "ì•ˆí‹° ê·¸ë ™",
    CurrentValue = false,
    Callback = function(Value)
        antiGrabEnabled = Value

        -- ì¼œê¸°
        if antiGrabEnabled then
            local rs = game:GetService("ReplicatedStorage")
            local plr = game.Players.LocalPlayer
            local character = plr.Character or plr.CharacterAdded:Wait()
            local torso = character:FindFirstChild("HumanoidRootPart") 
                          or character:FindFirstChild("Torso") 
                          or character:FindFirstChild("UpperTorso")
            local isAnchored = false

            antiGrabConnection = runService.Heartbeat:Connect(function()
                -- Struggle í˜¸ì¶œ
                rs.CharacterEvents.Struggle:FireServer(plr)
                
                -- Player ì•ˆì˜ IsHeld í™•ì¸
                local heldValue = plr:FindFirstChild("IsHeld")
                if heldValue and heldValue.Value == true then
                    if not isAnchored then
                        if torso then
                            torso.Anchored = true
                            isAnchored = true
                        end
                    end
                else
                    if isAnchored then
                        if torso then
                            torso.Anchored = false
                            isAnchored = false
                        end
                    end
                end
            end)

        -- ë„ê¸°
        else
            if antiGrabConnection then
                antiGrabConnection:Disconnect()
                antiGrabConnection = nil
            end
            -- í˜¹ì‹œ ê³ ì •ë¼ìˆìœ¼ë©´ í’€ê¸°
            local char = game.Players.LocalPlayer.Character
            if char then
                local torso = char:FindFirstChild("HumanoidRootPart") 
                              or char:FindFirstChild("Torso") 
                              or char:FindFirstChild("UpperTorso")
                if torso then
                    torso.Anchored = false
                end
            end
        end
    end
})

-- ğŸ“Œ í…”ë ˆí¬íŠ¸ íƒ­ ìƒì„±
local TeleportTab = Window:CreateTab("í…”ë ˆí¬íŠ¸", 4483362458)
local player = game.Players.LocalPlayer
local runService = game:GetService("RunService")

-- ìŠ¤í° êµ¬ì—­ í…”ë ˆí¬íŠ¸ ë²„íŠ¼
TeleportTab:CreateButton({
    Name = "ìŠ¤í° êµ¬ì—­ìœ¼ë¡œ ì´ë™",
    Callback = function()
        local char = player.Character or player.CharacterAdded:Wait()
        local root = char:WaitForChild("HumanoidRootPart")
        local spawnLocation = workspace:FindFirstChildWhichIsA("SpawnLocation")

        if spawnLocation then
            root.CFrame = spawnLocation.CFrame + Vector3.new(0, 5, 0)
            Rayfield:Notify({ Title = "í…”ë ˆí¬íŠ¸ ì„±ê³µ", Content = "ìŠ¤í° ì§€ì ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.", Duration = 3 })
        else
            Rayfield:Notify({ Title = "í…”ë ˆí¬íŠ¸ ì‹¤íŒ¨", Content = "ìŠ¤í° êµ¬ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", Duration = 5 })
        end
    end
})

-- í”Œë ˆì´ì–´ ëª©ë¡ ì¤€ë¹„ (í‘œì‹œë‹‰ + ë³¸ë‹‰)
local function getPlayerList()
    local list = {}
    for _, plr in ipairs(game.Players:GetPlayers()) do
        if plr ~= player then
            table.insert(list, plr.DisplayName .. " (" .. plr.Name .. ")")
        end
    end
    return list
end

local SelectedPlayer = nil

-- ë“œë¡­ë‹¤ìš´
local PlayerDropdown = TeleportTab:CreateDropdown({
    Name = "í”Œë ˆì´ì–´ ì„ íƒ",
    Options = getPlayerList(),
    CurrentOption = "",
    MultiSelection = false,
    Callback = function(option)
        if type(option) == "table" then
            option = option[1]
        end
        -- ë³¸ë‹‰(Name)ë§Œ ì¶”ì¶œ
        local selectedName = option:match("%((.-)%)")
        SelectedPlayer = game.Players:FindFirstChild(selectedName)

        if SelectedPlayer then
            Rayfield:Notify({
                Title = "ì„ íƒë¨",
                Content = SelectedPlayer.DisplayName .. " (" .. SelectedPlayer.Name .. ") ë‹˜ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.",
                Duration = 3
            })
        end
    end
})

-- í”Œë ˆì´ì–´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
TeleportTab:CreateButton({
    Name = "í”Œë ˆì´ì–´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨",
    Callback = function()
        -- ìµœì‹  í”Œë ˆì´ì–´ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        local refreshedList = {}
        for _, plr in ipairs(game.Players:GetPlayers()) do
            if plr ~= player then
                table.insert(refreshedList, plr.DisplayName .. " (" .. plr.Name .. ")")
            end
        end

        -- ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ì™„ì „íˆ ìƒˆë¡œ ì ìš©
        PlayerDropdown:Refresh(refreshedList, true)
        PlayerDropdown:SetOption("") -- ì„ íƒ ì´ˆê¸°í™”
        SelectedPlayer = nil

        Rayfield:Notify({
            Title = "ëª©ë¡ ìƒˆë¡œê³ ì¹¨",
            Content = "í”Œë ˆì´ì–´ ëª©ë¡ì´ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.",
            Duration = 3
        })
    end
})

-- ì„ íƒëœ í”Œë ˆì´ì–´ì—ê²Œ í…”ë ˆí¬íŠ¸ ë²„íŠ¼
TeleportTab:CreateButton({
    Name = "ì„ íƒí•œ í”Œë ˆì´ì–´í•œí…Œ í…”ë ˆí¬íŠ¸",
    Callback = function()
        if SelectedPlayer and SelectedPlayer.Character and SelectedPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local targetHRP = SelectedPlayer.Character.HumanoidRootPart
            local myChar = player.Character or player.CharacterAdded:Wait()
            local myHRP = myChar:WaitForChild("HumanoidRootPart")

            -- ë„¤íŠ¸ì›Œí¬ ì˜¤ë„ˆê¶Œ ê°€ì ¸ì˜¤ê¸° ì‹œë„ (ê°€ëŠ¥í•œ ê²Œì„ì—ì„œë§Œ)
            pcall(function()
                targetHRP:SetNetworkOwner(player)
            end)

            myHRP.CFrame = targetHRP.CFrame + Vector3.new(0, 3, 0)

            Rayfield:Notify({
                Title = "í…”ë ˆí¬íŠ¸ ì„±ê³µ",
                Content = SelectedPlayer.DisplayName .. " (" .. SelectedPlayer.Name .. ") ë‹˜ì—ê²Œ ì´ë™í–ˆìŠµë‹ˆë‹¤.",
                Duration = 3
            })
        else
            Rayfield:Notify({
                Title = "í…”ë ˆí¬íŠ¸ ì‹¤íŒ¨",
                Content = "í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì§€ ì•Šì•˜ê±°ë‚˜ ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
                Duration = 3
            })
        end
    end
})

-- ì‚¬ìš©ë²• íƒ­
local HelpTab = Window:CreateTab("ì‚¬ìš©ë²•", 4483362458)
HelpTab:CreateLabel("tí‚¤/ë²„íŠ¼ â†’ ë¸”ë¡ ë“±ë¡")
HelpTab:CreateLabel("yí‚¤ â†’ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ ë”°ë¼ê°€ê¸° / ë‹¤ì‹œ y â†’ ê³ ì • ìœ„ì¹˜")
HelpTab:CreateLabel("kí‚¤ â†’ í”Œë ˆì´ì–´ ì¶”ì ")
HelpTab:CreateLabel("zí‚¤ â†’ í…”ë ˆí¬íŠ¸")
HelpTab:CreateLabel("Uëª¨ë“œ â†’ ë³´í˜¸ë§‰ ëª¨ë“œ (ìŠ¬ë¼ì´ë”ë¡œ ë°˜ì§€ë¦„ ì¡°ì ˆ)")
HelpTab:CreateLabel("ë§ˆìš°ìŠ¤ íœ  â†’ yí‚¤ ê±°ë¦¬ ì¡°ì ˆ / U ëª¨ë“œ ë°˜ì§€ë¦„ ì¡°ì ˆ")
HelpTab:CreateLabel("ví‚¤/ë²„íŠ¼ â†’ ëª¨ë“  ë¸”ë¡ í•´ì œ")
HelpTab:CreateLabel("cí‚¤/ë²„íŠ¼ â†’ ìŠ¤í° ìœ„ì¹˜ ì´ë™")
HelpTab:CreateLabel("mí‚¤ â†’ UI í† ê¸€")

-- ê¸°ëŠ¥ í•¨ìˆ˜ë“¤
local function registerBlock(block)
    if block and block:IsA("BasePart") and not block.Anchored then
        registeredBlocks[block] = true
    end
end

local function unregisterAllBlocks()
    registeredBlocks = {}
end

local function restoreOwnership()
    for block in pairs(registeredBlocks) do
        if block.Parent and block:IsA("BasePart") then
            block.Anchored = false
            block:SetNetworkOwner(player)
        end
    end
end

-- ì›í˜• íšŒì „
local function updateCircularPlacement()
    local char = player.Character
    if not char or not char.PrimaryPart then return end

    local center = char.PrimaryPart.Position
    local count = 0
    for block in pairs(registeredBlocks) do
        if block.Parent then
            count += 1
        end
    end

    if count == 0 then return end

    local radius = baseRadius + (count-1)*radiusIncrement
    local speed = baseSpeed + (count-1)*speedIncrement
    local i = 0

    for block in pairs(registeredBlocks) do
        if block.Parent then
            local angle = (i/count)*math.pi*2 + angleOffset
            local targetPos = center + Vector3.new(math.cos(angle)*radius, 0, math.sin(angle)*radius)
            block.AssemblyLinearVelocity = (targetPos - block.Position) * speed
            i += 1
        end
    end
end

-- ìŠ¤í° ì´ë™
local function updateSpawnPlacement()
    local targetPos = spawnPos + Vector3.new(0,100,0)
    for block in pairs(registeredBlocks) do
        if block.Parent then
            block.AssemblyLinearVelocity = (targetPos - block.Position) * 5
        end
    end
end

-- í”Œë ˆì´ì–´ ì¶”ì 
local function updateTargetTracking()
    if not targetPlayer or not targetPlayer.Character or not targetPlayer.Character.PrimaryPart then return end

    local targetPos = targetPlayer.Character.PrimaryPart.Position
    for block in pairs(registeredBlocks) do
        if block.Parent then
            block.AssemblyLinearVelocity = (targetPos - block.Position) * 8
        end
    end
end

-- ë§ˆìš°ìŠ¤ ë”°ë¼ê°€ê¸°
local function updateFollowPointPlacement()
    local char = player.Character
    if not char or not char.PrimaryPart then return end

    local basePos = char.PrimaryPart.Position
    local targetCenter

    if followLockPos then
        targetCenter = followLockPos
    else
        local mouseRay = workspace.CurrentCamera:ScreenPointToRay(mouse.X, mouse.Y)
        local dir = mouseRay.Direction.Unit
        targetCenter = basePos + dir * followDistance
    end

    for block in pairs(registeredBlocks) do
        if block.Parent then
            block.AssemblyLinearVelocity = (targetCenter - block.Position) * 8
        end
    end
end

-- ìë™ ë°˜êµ¬ ë³´í˜¸ë§‰
local function updateDomePlacement()
    local char = player.Character
    if not char or not char.PrimaryPart then return end

    local center = char.PrimaryPart.Position
    local blocks = {}

    for block in pairs(registeredBlocks) do
        if block.Parent then
            table.insert(blocks, block)
        end
    end

    local total = #blocks
    if total == 0 then return end

    local layerHeight = 15
    local layerRadiusStep = 15
    local idx = 1
    local layers = math.ceil(math.sqrt(total))

    for layer = 0, layers-1 do
        local y = layer * layerHeight
        local radius = math.max(0, uDistance - layer*layerRadiusStep)
        local circumference = 2*math.pi*radius
        local cols = math.max(1, math.floor(circumference/10))

        for col = 0, cols-1 do
            if idx > total then return end
            local angle = (col/cols)*2*math.pi
            local x = radius * math.cos(angle)
            local z = radius * math.sin(angle)
            local block = blocks[idx]
            local targetPos = center + Vector3.new(x, y, z)
            block.AssemblyLinearVelocity = (targetPos - block.Position) * 10
            idx += 1
        end
    end
end

-- Rayfield ë²„íŠ¼
MainTab:CreateButton({ Name="ë¸”ë¡ ë“±ë¡ (ë§ˆìš°ìŠ¤)", Callback=function()
    local target = mouse.Target
    registerBlock(target)
end})

MainTab:CreateButton({ Name="ëª¨ë“  ë¸”ë¡ í•´ì œ", Callback=unregisterAllBlocks })

MainTab:CreateButton({ Name="í…”ë ˆí¬íŠ¸ (ë§ˆìš°ìŠ¤ ìœ„ì¹˜)", Callback=function()
    local char = player.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        local root = char.HumanoidRootPart
        root.CFrame = CFrame.new(mouse.Hit.Position + Vector3.new(0,3,0))
    end
end})

MainTab:CreateToggle({
    Name="ë³´í˜¸ë§‰ ëª¨ë“œ",
    CurrentValue=uMode,
    Callback=function(Value)
        uMode = Value
        if uMode then
            followPointMode = false
            spawnMode = false
            targetPlayer = nil
            restoreOwnership()
        end
    end
})

MainTab:CreateSlider({
    Name="ë³´í˜¸ë§‰ ë°˜ì§€ë¦„",
    Range={10,300},
    Increment=5,
    CurrentValue=uDistance,
    Callback=function(Value)
        uDistance = Value
    end
})

-- í‚¤ë‹¤ìš´ ê¸°ëŠ¥
local function onKeyDown(key)
    if key=="t" then
        local target = mouse.Target
        registerBlock(target)
    elseif key=="y" then
        uMode=false
        if followPointMode and not followLockPos then
            local char=player.Character
            if char and char.PrimaryPart then
                local mouseRay = workspace.CurrentCamera:ScreenPointToRay(mouse.X, mouse.Y)
                local dir = mouseRay.Direction.Unit
                followLockPos = char.PrimaryPart.Position + dir*followDistance
            end
        elseif followPointMode and followLockPos then
            followLockPos=nil
            followPointMode=false
        else
            followPointMode=true
            followLockPos=nil
            restoreOwnership()
        end
    elseif key=="k" then
        uMode=false
        local target = mouse.Target
        local newTargetPlayer = nil
        if target then
            local model = target:FindFirstAncestorWhichIsA("Model")
            if model and game.Players:GetPlayerFromCharacter(model) and model ~= player.Character then
                newTargetPlayer = game.Players:GetPlayerFromCharacter(model)
            end
        end
        if newTargetPlayer then
            targetPlayer=newTargetPlayer
            followPointMode=false
            followLockPos=nil
            spawnMode=false
            for block in pairs(registeredBlocks) do
                if block and block.Parent then
                    block:SetNetworkOwner(player)
                end
            end
        else
            targetPlayer=nil
        end
    elseif key=="z" then
        local char=player.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            char.HumanoidRootPart.CFrame = CFrame.new(mouse.Hit.Position + Vector3.new(0,3,0))
        end
    elseif key=="v" then
        unregisterAllBlocks()
    elseif key=="c" then
        uMode=false
        spawnMode=not spawnMode
        if spawnMode then
            followPointMode=false
            followLockPos=nil
            targetPlayer=nil
            restoreOwnership()
        end
    elseif key=="m" then
        Window:Toggle()
    end
end

mouse.KeyDown:Connect(onKeyDown)

-- Heartbeat ë£¨í”„
runService.Heartbeat:Connect(function()
    if uMode then
        updateDomePlacement()
        ModeLabel:Set("í˜„ì¬ ëª¨ë“œ: ë³´í˜¸ë§‰ ëª¨ë“œ (ë°˜ì§€ë¦„ "..uDistance..")")
    elseif targetPlayer then
        updateTargetTracking()
        ModeLabel:Set("í˜„ì¬ ëª¨ë“œ: í”Œë ˆì´ì–´ ì¶”ì  â†’ "..targetPlayer.Name)
    elseif followPointMode then
        updateFollowPointPlacement()
        if followLockPos then
            ModeLabel:Set("í˜„ì¬ ëª¨ë“œ: ê³ ì • ìœ„ì¹˜ ìœ ì§€")
        else
            ModeLabel:Set("í˜„ì¬ ëª¨ë“œ: ë§ˆìš°ìŠ¤ ì´ë™ ("..followDistance.." Studs)")
        end
    elseif spawnMode then
        updateSpawnPlacement()
        ModeLabel:Set("í˜„ì¬ ëª¨ë“œ: ìŠ¤í° ìœ„ì¹˜ ì´ë™")
    else
        angleOffset += (baseSpeed + (#registeredBlocks-1)*speedIncrement) * 0.01
        updateCircularPlacement()
        ModeLabel:Set("í˜„ì¬ ëª¨ë“œ: ì›í˜• íšŒì „")
    end
end)

-- ë§ˆìš°ìŠ¤ íœ 
mouse.WheelForward:Connect(function()
    if followPointMode and not followLockPos then
        followDistance = math.min(followDistance+5,300)
    elseif uMode then
        uDistance = math.min(uDistance+5,300)
    end
end)

mouse.WheelBackward:Connect(function()
    if followPointMode and not followLockPos then
        followDistance = math.max(followDistance-5,10)
    elseif uMode then
        uDistance = math.max(uDistance-5,10)
    end
end)
